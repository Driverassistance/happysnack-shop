<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FF6B35">
    <title>HappySnack - –ö–∞—Ç–∞–ª–æ–≥</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #FF6B35 0%, #FF8C61 100%);
            padding: 20px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .search-box {
            background: white;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .search-box input {
            border: none;
            outline: none;
            flex: 1;
            font-size: 16px;
            color: #333;
        }

        .categories {
            display: flex;
            overflow-x: auto;
            padding: 15px;
            gap: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .categories::-webkit-scrollbar {
            display: none;
        }

        .category-chip {
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 10px 20px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-chip.active {
            background: #FF6B35;
            color: white;
            border-color: #FF6B35;
        }

        .products {
            padding: 15px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: #f5f5f5;
            flex-shrink: 0;
        }

        .product-image.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .product-price {
            font-size: 18px;
            font-weight: bold;
            color: #FF6B35;
            margin-bottom: 5px;
        }

        .product-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 5px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #FF6B35;
            color: white;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .qty-display {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
            color: #333;
        }

        .discount-banner {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            padding: 15px 20px;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .discount-banner h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .discount-banner p {
            font-size: 14px;
            opacity: 0.95;
        }

        .motivation-banner {
            background: linear-gradient(135deg, #9C27B0 0%, #BA68C8 100%);
            color: white;
            padding: 15px 20px;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(156, 39, 176, 0.3);
        }

        .motivation-banner h3 {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #9C27B0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }

        #loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
        }

        /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ö–û–†–ó–ò–ù–´ */
        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            overflow-y: auto;
            animation: fadeIn 0.3s;
        }

        .cart-modal.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .cart-content {
            background: white;
            margin: 20px;
            border-radius: 16px;
            padding: 20px;
            min-height: calc(100vh - 40px);
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f5f5f5;
        }

        .cart-header h2 {
            font-size: 24px;
            color: #333;
        }

        .close-cart {
            font-size: 28px;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
        }

        .cart-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .cart-item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .cart-item-price {
            color: #FF6B35;
            font-weight: bold;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .upsell-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .upsell-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        .upsell-item {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .upsell-item:active {
            transform: scale(0.98);
        }

        .upsell-item-image {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .upsell-item-info {
            flex: 1;
        }

        .upsell-item-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .upsell-item-price {
            color: #FF6B35;
            font-size: 14px;
            font-weight: bold;
        }

        .add-upsell-btn {
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
        }

        .cart-summary {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
        }

        .summary-row.total {
            font-size: 20px;
            font-weight: bold;
            color: #FF6B35;
            padding-top: 15px;
            border-top: 2px solid #ddd;
            margin-top: 10px;
        }

        .payment-method {
            margin: 20px 0;
        }

        .payment-method h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        .payment-options {
            display: flex;
            gap: 10px;
        }

        .payment-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-option.active {
            border-color: #FF6B35;
            background: #FFF5F2;
            color: #FF6B35;
            font-weight: bold;
        }

        .comment-section {
            margin: 20px 0;
        }

        .comment-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        .comment-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .confirm-order-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #FF6B35 0%, #FF8C61 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        .confirm-order-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #regModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
        }

        .modal-content h2 {
            margin-bottom: 16px;
            color: #FF6B35;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .modal-content button {
            width: 100%;
            padding: 14px;
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞...</div>
    </div>

    <div class="header">
        <h1>üçø HappySnack</h1>
        <div class="search-box">
            <span>üîç</span>
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤...">
        </div>
    </div>

    <div class="discount-banner" id="discountBanner" style="display: none;">
        <h3>üéâ –ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ —Å–æ —Å–∫–∏–¥–∫–æ–π!</h3>
        <p>–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–∫–∞–∑–µ –æ—Ç 10,000‚Ç∏ —Å–∫–∏–¥–∫–∞ 5%</p>
    </div>

    <div class="motivation-banner" id="motivationBanner" style="display: none;">
        <h3 id="motivationText">üíé –î–æ –±–æ–Ω—É—Å–∞ –æ—Å—Ç–∞–ª–æ—Å—å —Å–æ–≤—Å–µ–º —á—É—Ç—å-—á—É—Ç—å!</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="motivationProgress" style="width: 0%">0%</div>
        </div>
        <p id="motivationSubtext">–î–æ–±–∞–≤—å—Ç–µ –µ—â—ë —Ç–æ–≤–∞—Ä–æ–≤ –∏ –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫!</p>
    </div>

    <div class="categories" id="categories"></div>
    <div class="products" id="products"></div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ö–û–†–ó–ò–ù–´ -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
                <button class="close-cart" onclick="closeCart()">√ó</button>
            </div>

            <div id="cartItems"></div>

            <div class="upsell-section" id="upsellSection" style="display: none;">
                <h3>üî• –ß–∞—Å—Ç–æ –±–µ—Ä—É—Ç –≤–º–µ—Å—Ç–µ</h3>
                <div id="upsellItems"></div>
            </div>

            <div class="cart-summary">
                <div class="summary-row">
                    <span>–¢–æ–≤–∞—Ä—ã:</span>
                    <span id="cartSubtotal">0‚Ç∏</span>
                </div>
                <div class="summary-row" id="bonusRow" style="display: none;">
                    <span>üíé –ë–æ–Ω—É—Å—ã –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é:</span>
                    <span id="cartBonus">0‚Ç∏</span>
                </div>
                <div class="summary-row total">
                    <span>–ò—Ç–æ–≥–æ:</span>
                    <span id="cartTotal">0‚Ç∏</span>
                </div>
            </div>

            <div class="payment-method">
                <h3>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
                <div class="payment-options">
                    <div class="payment-option active" data-method="cash" onclick="selectPayment('cash')">
                        üíµ –ù–∞–ª–∏—á–Ω—ã–µ
                    </div>
                    <div class="payment-option" data-method="card" onclick="selectPayment('card')">
                        üí≥ –ë–µ–∑–Ω–∞–ª
                    </div>
                </div>
            </div>

            <div class="comment-section">
                <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</h3>
                <textarea class="comment-input" id="orderComment" placeholder="–£–∫–∞–∂–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏, –∞–¥—Ä–µ—Å –∏–ª–∏ –¥—Ä—É–≥–∏–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è..."></textarea>
            </div>

            <button class="confirm-order-btn" onclick="confirmOrder()">
                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
            </button>
        </div>
    </div>

    <div id="regModal">
        <div class="modal-content">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <p style="margin-bottom: 16px; color: #666;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞:</p>
            <input type="text" id="regCompanyName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ / –ò–ü">
            <input type="text" id="regAddress" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏">
            <input type="tel" id="regPhone" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω">
            <button onclick="submitRegistration()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>

<script>
    let tg = null;
    let products = [];
    let categories = [];
    let cart = {};
    let currentCategory = 'all';
    let is_first_order = false;
    let needsRegistration = false;
    let selectedPaymentMethod = 'cash';

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ (–º–æ–∂–Ω–æ –±—É–¥–µ—Ç –≤—ã–Ω–µ—Å—Ç–∏ –≤ –¥–∞—à–±–æ—Ä–¥)
    const MOTIVATION_TIERS = [
        { threshold: 15000, bonus: '–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞', emoji: 'üöö' },
        { threshold: 25000, bonus: '–£–ø–∞–∫–æ–≤–∫–∞ –∫–≤–∞—Å–∞ –≤ –ø–æ–¥–∞—Ä–æ–∫', emoji: 'ü•§' },
        { threshold: 50000, bonus: '5% —Å–∫–∏–¥–∫–∞ –Ω–∞ –∑–∞–∫–∞–∑', emoji: 'üí∞' }
    ];

    function getTg() {
        return window.Telegram?.WebApp || null;
    }

    function hideLoader() {
        const loader = document.getElementById('loader');
        if (loader) {
            loader.classList.add('hidden');
            setTimeout(() => loader.style.display = 'none', 300);
        }
    }

    function formatPrice(price) {
        return parseInt(price).toLocaleString();
    }

    function getProductWord(count) {
        if (count % 10 === 1 && count % 100 !== 11) return '—Ç–æ–≤–∞—Ä';
        if ([2,3,4].includes(count % 10) && ![12,13,14].includes(count % 100)) return '—Ç–æ–≤–∞—Ä–∞';
        return '—Ç–æ–≤–∞—Ä–æ–≤';
    }

    function renderCategories() {
        const container = document.getElementById('categories');
        if (!container) return;

        const allButton = `<div class="category-chip active" data-category="all" onclick="filterByCategory('all')">–í—Å–µ</div>`;
        const categoryButtons = categories.map(cat => 
            `<div class="category-chip" data-category="${cat.id}" onclick="filterByCategory(${cat.id})">
                ${cat.icon} ${cat.name}
            </div>`
        ).join('');

        container.innerHTML = allButton + categoryButtons;

        if (is_first_order) {
            const banner = document.getElementById('discountBanner');
            if (banner) banner.style.display = 'block';
        }
    }

    function renderProducts() {
        const productsContainer = document.getElementById('products');
        if (!productsContainer) return;

        if (!products || !products.length) {
            productsContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                </div>
            `;
            return;
        }

        productsContainer.innerHTML = products.map(product => {
            if (currentCategory !== 'all' && product.category_id != currentCategory) {
                return '';
            }

            const count = cart[product.id] || 0;

            return `
                <div class="product-card">
                    ${product.photo_url 
                        ? `<img src="${product.photo_url}" alt="${product.name}" class="product-image" loading="lazy">`
                        : '<div class="product-image placeholder">üì∑</div>'
                    }
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${parseInt(product.price).toLocaleString()} ‚Ç∏</div>
                        
                        <div class="product-actions">
                            ${count === 0 
                                ? `<button class="qty-btn" style="width: 100%;" onclick="changeQty(${product.id}, 1)">–î–æ–±–∞–≤–∏—Ç—å</button>`
                                : `<div class="qty-control">
                                       <button class="qty-btn" onclick="changeQty(${product.id}, -1)">‚àí</button>
                                       <span class="qty-display">${count}</span>
                                       <button class="qty-btn" onclick="changeQty(${product.id}, 1)">+</button>
                                   </div>`
                            }
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        updateCartDisplay();
    }

    function filterByCategory(categoryId) {
        currentCategory = categoryId;
        document.querySelectorAll('.category-chip').forEach(chip => {
            chip.classList.toggle('active', chip.dataset.category == categoryId);
        });
        renderProducts();
    }

    window.changeQty = function(productId, delta) {
        const product = products.find(p => p.id === productId);
        if (!product) return;

        const current = cart[productId] || 0;
        const newQty = Math.max(0, current + delta);

        if (newQty === 0) {
            delete cart[productId];
        } else {
            cart[productId] = newQty;
        }

        renderProducts();
        updateCartDisplay();
        updateMotivation();
    };

    function updateCartDisplay() {
        const itemCount = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
        const total = calculateTotal();

        if (!tg || !tg.MainButton) return;

        if (itemCount === 0) {
            tg.MainButton.hide();
            return;
        }

        tg.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑: ${formatPrice(total)}‚Ç∏`);
        tg.MainButton.show();
        tg.MainButton.enable();
    }

    function calculateTotal() {
        return Object.entries(cart).reduce((sum, [id, qty]) => {
            const product = products.find(p => String(p.id) === String(id));
            return sum + (product ? (product.price || 0) * qty : 0);
        }, 0);
    }

    function updateMotivation() {
        const total = calculateTotal();
        const banner = document.getElementById('motivationBanner');
        
        // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π –ø–æ—Ä–æ–≥
        const nextTier = MOTIVATION_TIERS.find(tier => total < tier.threshold);
        
        if (nextTier && total > 0) {
            const remaining = nextTier.threshold - total;
            const progress = (total / nextTier.threshold) * 100;
            
            banner.style.display = 'block';
            document.getElementById('motivationText').textContent = 
                `${nextTier.emoji} ${nextTier.bonus}`;
            document.getElementById('motivationProgress').style.width = `${progress}%`;
            document.getElementById('motivationProgress').textContent = `${Math.round(progress)}%`;
            document.getElementById('motivationSubtext').textContent = 
                `–î–æ–±–∞–≤—å—Ç–µ –µ—â—ë –Ω–∞ ${formatPrice(remaining)}‚Ç∏`;
        } else {
            banner.style.display = 'none';
        }
    }

    function showCart() {
        const modal = document.getElementById('cartModal');
        const itemsContainer = document.getElementById('cartItems');
        
        // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ
        let cartHTML = '';
        let subtotal = 0;
        
        Object.entries(cart).forEach(([productId, qty]) => {
            const product = products.find(p => p.id == productId);
            if (!product) return;
            
            const itemTotal = product.price * qty;
            subtotal += itemTotal;
            
            cartHTML += `
                <div class="cart-item">
                    <div class="cart-item-image">üì∑</div>
                    <div class="cart-item-info">
                        <div class="cart-item-name">${product.name}</div>
                        <div class="cart-item-price">${formatPrice(product.price)}‚Ç∏ √ó ${qty}</div>
                        <div class="cart-item-controls">
                            <div class="qty-control">
                                <button class="qty-btn" onclick="changeQty(${product.id}, -1)">‚àí</button>
                                <span class="qty-display">${qty}</span>
                                <button class="qty-btn" onclick="changeQty(${product.id}, 1)">+</button>
                            </div>
                            <span style="margin-left: auto; font-weight: bold;">${formatPrice(itemTotal)}‚Ç∏</span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        itemsContainer.innerHTML = cartHTML;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
        document.getElementById('cartSubtotal').textContent = `${formatPrice(subtotal)}‚Ç∏`;
        document.getElementById('cartTotal').textContent = `${formatPrice(subtotal)}‚Ç∏`;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–æ–Ω—É—Å—ã
        const bonuses = Math.floor(subtotal * 0.03); // 3% –±–æ–Ω—É—Å–æ–≤
        if (bonuses > 0) {
            document.getElementById('bonusRow').style.display = 'flex';
            document.getElementById('cartBonus').textContent = `+${formatPrice(bonuses)}‚Ç∏`;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø—Ä–æ–¥–∞–∂–∏
        showUpsells();
        
        modal.classList.add('active');
    }

    function showUpsells() {
        const upsellSection = document.getElementById('upsellSection');
        const upsellContainer = document.getElementById('upsellItems');
        
        // –ë–µ—Ä—ë–º 3 —Å–ª—É—á–∞–π–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω–µ
        const availableProducts = products.filter(p => !cart[p.id]);
        const randomProducts = availableProducts
            .sort(() => Math.random() - 0.5)
            .slice(0, 3);
        
        if (randomProducts.length > 0) {
            upsellSection.style.display = 'block';
            upsellContainer.innerHTML = randomProducts.map(product => `
                <div class="upsell-item">
                    <div class="upsell-item-image">üì∑</div>
                    <div class="upsell-item-info">
                        <div class="upsell-item-name">${product.name}</div>
                        <div class="upsell-item-price">${formatPrice(product.price)}‚Ç∏</div>
                    </div>
                    <button class="add-upsell-btn" onclick="addUpsell(${product.id})">+</button>
                </div>
            `).join('');
        } else {
            upsellSection.style.display = 'none';
        }
    }

    window.addUpsell = function(productId) {
        cart[productId] = 1;
        showCart(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—É
        renderProducts(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–∞–ª–æ–≥
        updateMotivation();
    };

    window.closeCart = function() {
        document.getElementById('cartModal').classList.remove('active');
    };

    window.selectPayment = function(method) {
        selectedPaymentMethod = method;
        document.querySelectorAll('.payment-option').forEach(opt => {
            opt.classList.toggle('active', opt.dataset.method === method);
        });
    };

    window.confirmOrder = async function() {
        if (!tg) return;

        closeCart();
        tg.MainButton.showProgress();

        try {
            const orderData = {
                user_id: tg.initDataUnsafe.user?.id,
                cart: cart,
                payment_method: selectedPaymentMethod,
                notes: document.getElementById('orderComment').value || ''
            };

            const response = await fetch('/api/orders/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                const bonuses = Math.floor(result.total * 0.03);
                
                tg.showAlert(
                    `‚úÖ –ó–∞–∫–∞–∑ #${result.order_id} –ø—Ä–∏–Ω—è—Ç!\n\n` +
                    `üí∞ –°—É–º–º–∞: ${formatPrice(result.total)}‚Ç∏\n` +
                    `üéÅ –ë–æ–Ω—É—Å–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +${formatPrice(bonuses)}‚Ç∏\n\n` +
                    `–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.`
                );

                cart = {};
                updateCartDisplay();
                renderProducts();
                updateMotivation();

                setTimeout(() => tg.close(), 3000);
            } else {
                throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–∫–∞–∑–∞:', error);
            tg.showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        } finally {
            tg.MainButton.hideProgress();
        }
    };

    async function loadData() {
        try {
            let userId = '';
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                userId = tg.initDataUnsafe.user.id;
            }

            const response = await fetch(`/api/catalog?user_id=${userId}`, { cache: 'no-store' });
            const data = await response.json();

            products = data.products || [];
            categories = data.categories || [];
            is_first_order = !!data.is_first_order;
            needsRegistration = !!data.needs_registration;

            renderCategories();
            renderProducts();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        } finally {
            hideLoader();
        }
    }

    window.submitRegistration = async function() {
        const company = document.getElementById('regCompanyName').value;
        const address = document.getElementById('regAddress').value;
        const phone = document.getElementById('regPhone').value;

        if (!company || !address || !phone) {
            tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
            return;
        }

        tg.MainButton.showProgress();

        try {
            const regResponse = await fetch('/api/client/profile/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: tg.initDataUnsafe.user?.id,
                    company_name: company,
                    address: address,
                    contact_phone: phone
                })
            });

            if (regResponse.ok) {
                needsRegistration = false;
                document.getElementById('regModal').style.display = 'none';
                showCart();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        } catch (e) {
            tg.showAlert('–û—à–∏–±–∫–∞: ' + e.message);
            tg.MainButton.hideProgress();
        }
    };

    function startApp() {
        tg = getTg();

        if (tg) {
            tg.ready();
            tg.expand();

            tg.MainButton.onClick(async () => {
                if (needsRegistration) {
                    document.getElementById('regModal').style.display = 'flex';
                    return;
                }

                showCart();
            });
        } else {
            console.warn('Telegram WebApp not detected (ok for browser test).');
        }

        setTimeout(() => hideLoader(), 8000);
        loadData();
    }

    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (query) {
                const filtered = products.filter(p => 
                    p.name.toLowerCase().includes(query)
                );
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Ç–æ–≤–∞—Ä–æ–≤
            }
        });
    }

    document.addEventListener('DOMContentLoaded', startApp);
</script>

</body>
</html>