<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FF6B35">
    <title>HappySnack - –ö–∞—Ç–∞–ª–æ–≥</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #FF6B35 0%, #FF8C61 100%);
            padding: 20px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .search-box {
            background: white;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .search-box input {
            border: none;
            outline: none;
            flex: 1;
            font-size: 16px;
            color: #333;
        }

        .categories {
            display: flex;
            overflow-x: auto;
            padding: 15px;
            gap: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .categories::-webkit-scrollbar {
            display: none;
        }

        .category-chip {
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 10px 20px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-chip.active {
            background: #FF6B35;
            color: white;
            border-color: #FF6B35;
        }

        .products {
            padding: 15px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: #f5f5f5;
            flex-shrink: 0;
        }

        .product-image.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .product-price {
            font-size: 18px;
            font-weight: bold;
            color: #FF6B35;
            margin-bottom: 5px;
        }

        .product-stock {
            font-size: 13px;
            color: #666;
        }

        .product-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 5px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #FF6B35;
            color: white;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .qty-display {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
        }

        .cart-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FF6B35 0%, #FF8C61 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 18px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
        }

        .cart-button:disabled {
            background: #ccc;
            box-shadow: none;
        }

        .discount-banner {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            padding: 15px 20px;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .discount-banner h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .discount-banner p {
            font-size: 14px;
            opacity: 0.95;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .install-prompt {
            background: linear-gradient(135deg, #2196F3 0%, #42A5F5 100%);
            color: white;
            padding: 15px 20px;
            margin: 15px;
            border-radius: 12px;
            display: none;
        }

        .install-prompt button {
            background: white;
            color: #2196F3;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }
    
    /* –ü—Ä–µ–ª–æ–∞–¥–µ—Ä */
    #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        transition: opacity 0.3s ease;
    }
    
    #loader.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .loader-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255,255,255,0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    .loader-text {
        color: white;
        margin-top: 20px;
        font-size: 16px;
        font-weight: 500;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è */
    body.loading #app {
        opacity: 0;
    }
    
    body.loaded #app {
        opacity: 1;
        transition: opacity 0.3s ease;
    }

    </style>
</head>
<body class="loading">
    <div id="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">üçø –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥...</div>
    </div>

    <div id="installPrompt" class="install-prompt">
        <h3>üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
        <p>–î–æ–±–∞–≤—å—Ç–µ HappySnack –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞!</p>
        <button onclick="installApp()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div class="header">
        <h1>üçø HappySnack</h1>
        <div class="search-box">
            <span style="margin-right: 10px;">üîç</span>
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤...">
        </div>
    </div>

    <div id="discountBanner" class="discount-banner" style="display: none;">
        <h3>üéâ –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!</h3>
        <p id="discountText"></p>
    </div>

    <div class="categories" id="categories">
        <div class="category-chip active" data-category="all">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</div>
    </div>

    <div class="products" id="products">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
    </div>

    <button class="cart-button" id="cartButton" disabled>
        <span id="cartInfo">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</span>
        <span id="cartTotal">0‚Ç∏</span>
    </button>

    <script>
        // ===== –ü–†–ï–õ–û–ê–î–ï–† =====
        function hideLoader() {
            const loader = document.getElementById('loader');
            document.body.classList.remove('loading');
            document.body.classList.add('loaded');
            if (loader) {
                loader.classList.add('hidden');
                setTimeout(() => loader.remove(), 300);
            }
        }

        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM WEBAPP (–ò–°–ü–†–ê–í–õ–ï–ù–û) =====
        const tg = window.Telegram.WebApp;
        tg.ready(); // –°–Ω–∞—á–∞–ª–∞ —Å–æ–æ–±—â–∞–µ–º, —á—Ç–æ –≥–æ—Ç–æ–≤—ã
        tg.expand(); // –ü–æ—Ç–æ–º —Ä–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        let products = [];
        let categories = [];
        let cart = {};
        let currentCategory = 'all';
        let isFirstOrder = false;
        let deferredPrompt;

        // PWA Install
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA installed');
                    }
                    deferredPrompt = null;
                    document.getElementById('installPrompt').style.display = 'none';
                });
            }
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then((reg) => console.log('Service Worker registered', reg))
                .catch((err) => console.log('Service Worker registration failed', err));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            try {
                const initData = tg.initDataUnsafe;
                const userId = initData.user?.id;

                // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ—Ç API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
                const response = await fetch(`/api/catalog?user_id=${userId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                products = data.products || [];
                categories = data.categories || [];
                isFirstOrder = data.is_first_order || false;

                renderCategories();
                renderProducts();
                updateDiscountBanner();
                hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                document.getElementById('products').innerHTML = 
                    '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</p></div>';
                hideLoader(); // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
        }

        function renderCategories() {
            const container = document.getElementById('categories');
            const allChip = container.querySelector('[data-category="all"]');
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ "–í—Å–µ —Ç–æ–≤–∞—Ä—ã"
            if (allChip) {
                allChip.onclick = () => filterByCategory('all');
            }

            categories.forEach(cat => {
                const chip = document.createElement('div');
                chip.className = 'category-chip';
                chip.dataset.category = cat.id;
                chip.textContent = `${cat.icon || 'üì¶'} ${cat.name}`;
                chip.onclick = () => filterByCategory(cat.id);
                container.appendChild(chip);
            });
        }

        function renderProducts() {
            const container = document.getElementById('products');
            const filtered = currentCategory === 'all' 
                ? products 
                : products.filter(p => p.category_id === currentCategory);

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
                return;
            }

            container.innerHTML = filtered.map(product => `
                <div class="product-card">
                    ${product.photo_url 
                        ? `<img src="${product.photo_url}" class="product-image" alt="${product.name}">`
                        : `<div class="product-image placeholder">üì¶</div>`
                    }
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${formatPrice(product.price)}‚Ç∏</div>
                        <div class="product-stock">–û—Å—Ç–∞—Ç–æ–∫: ${product.stock} —à—Ç</div>
                    </div>
                    <div class="product-actions">
                        <div class="qty-control">
                            <button class="qty-btn" onclick="changeQty(${product.id}, -1)">‚àí</button>
                            <div class="qty-display" id="qty-${product.id}">${cart[product.id] || 0}</div>
                            <button class="qty-btn" onclick="changeQty(${product.id}, 1)">+</button>
                        </div>
                    </div>
                </div>
            `).join('');

            updateCartDisplay();
        }

        function filterByCategory(categoryId) {
            currentCategory = categoryId;
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.category == categoryId);
            });
            renderProducts();
        }

        function changeQty(productId, delta) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const current = cart[productId] || 0;
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫
            const newQty = Math.max(0, Math.min(product.stock, current + delta));


            if (newQty === 0) {
                delete cart[productId];
            } else {
                cart[productId] = newQty;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏—Å–ø–ª–µ–π –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            const qtyDisplay = document.getElementById(`qty-${productId}`);
            if (qtyDisplay) {
                qtyDisplay.textContent = newQty;
            }
            
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartBtn = document.getElementById('cartButton');
            const cartInfo = document.getElementById('cartInfo');
            const cartTotal = document.getElementById('cartTotal');

            const itemCount = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
            const total = Object.entries(cart).reduce((sum, [id, qty]) => {
                const product = products.find(p => p.id == id);
                return sum + (product ? product.price * qty : 0);
            }, 0);

            if (itemCount === 0) {
                cartBtn.disabled = true;
                cartInfo.textContent = '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
                cartTotal.textContent = '0‚Ç∏';
                tg.MainButton.hide();
            } else {
                cartBtn.disabled = false;
                cartInfo.textContent = `${itemCount} ${getProductWord(itemCount)}`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º MainButton –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞
                tg.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑: ${formatPrice(total)}‚Ç∏`);
                tg.MainButton.show();
                
                let displayTotal = total;
                if (isFirstOrder) {
                    const discount = calculateDiscount(total);
                    displayTotal = total - discount;
                }
                
                cartTotal.textContent = `${formatPrice(displayTotal)}‚Ç∏`;
            }
        }

        function calculateDiscount(total) {
            if (!isFirstOrder) return 0;
            if (total >= 50000) return total * 0.20;
            if (total >= 25000) return total * 0.15;
            if (total >= 15000) return total * 0.10;
            return 0;
        }

        function updateDiscountBanner() {
            const banner = document.getElementById('discountBanner');
            const text = document.getElementById('discountText');
            
            if (isFirstOrder) {
                banner.style.display = 'block';
                text.textContent = '–ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑: —Å–∫–∏–¥–∫–∞ 10-20% –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 15,000‚Ç∏!';
            }
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(price));
        }

        function getProductWord(count) {
            const lastDigit = count % 10;
            const lastTwoDigits = count % 100;
            
            if (lastTwoDigits >= 11 && lastTwoDigits <= 19) return '—Ç–æ–≤–∞—Ä–æ–≤'; 
            if (lastDigit === 1) return '—Ç–æ–≤–∞—Ä'; 
            if (lastDigit >= 2 && lastDigit <= 4) return '—Ç–æ–≤–∞—Ä–∞';
            return '—Ç–æ–≤–∞—Ä–æ–≤'; 
        }

        // –ü–æ–∏—Å–∫
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            // TODO: Implement search filtering
            console.log("–ü–æ–∏—Å–∫ –ø–æ:", query);
        });

        // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò –ö–û–†–ó–ò–ù–´ (–ò–°–ü–†–ê–í–õ–ï–ù–û: —É–¥–∞–ª–µ–Ω–æ tg.close) =====
        document.getElementById('cartButton').addEventListener('click', () => {
            console.log('üõí –ö–Ω–æ–ø–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –Ω–∞–∂–∞—Ç–∞! –ò–Ω–∏—Ü–∏–∏—Ä—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö...');
            
            // 1. –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é —Å—É–º–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const totalOrderPrice = Object.entries(cart).reduce((sum, [id, qty]) => {
                const product = products.find(p => p.id == id);
                return sum + (product ? product.price * qty : 0);
            }, 0);
            
            const orderData = JSON.stringify({
                action: 'checkout',
                cart: cart,
                total: totalOrderPrice, // –ü–æ–ª–Ω–∞—è —Å—É–º–º–∞ –¥–æ —Å–∫–∏–¥–∫–∏
                display_total: totalOrderPrice - calculateDiscount(totalOrderPrice), // –°—É–º–º–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π
                is_first_order: isFirstOrder
            });
            
            // 2. –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –º–µ–Ω—è–µ–º –µ–µ —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∏–¥–µ—Ç
            const cartBtn = document.getElementById('cartButton');
            const cartInfo = document.getElementById('cartInfo');
            const cartTotal = document.getElementById('cartTotal');
            
            cartBtn.disabled = true;
            cartInfo.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞...';
            cartTotal.textContent = '‚è≥';
            
            // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É. –ë–û–¢ –î–û–õ–ñ–ï–ù –ë–£–î–ï–¢ –ó–ê–ö–†–´–¢–¨ WEBAPP!
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ:', orderData);
            tg.sendData(orderData);
            console.log('‚úÖ tg.sendData –≤—ã–∑–≤–∞–Ω! –û–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–æ—Ç–∞...');
            
            // –£–î–ê–õ–ï–ù –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –í–´–ó–û–í tg.close() - –≠–¢–û –ë–´–õ–ê –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();
    </script>
</body>
</html>