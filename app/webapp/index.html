<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FF6B35">
    <title>HappySnack - –ö–∞—Ç–∞–ª–æ–≥</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding-bottom: 140px;
        }

        .header {
            background: linear-gradient(135deg, #FF6B35 0%, #FF8C61 100%);
            padding: 20px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .search-box {
            background: white;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .search-box input {
            border: none;
            outline: none;
            flex: 1;
            font-size: 16px;
            color: #333;
        }

        .categories {
            display: flex;
            overflow-x: auto;
            padding: 15px;
            gap: 10px;
            background: white;
            -webkit-overflow-scrolling: touch;
        }

        .categories::-webkit-scrollbar {
            display: none;
        }

        .category-chip {
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 10px 20px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
            color: #333;
        }

        .category-chip.active {
            background: #FF6B35;
            color: white;
        }

        .products {
            padding: 15px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: #f5f5f5;
            flex-shrink: 0;
        }

        .product-image.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .product-price {
            font-size: 18px;
            font-weight: bold;
            color: #FF6B35;
            margin-bottom: 5px;
        }

        .product-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 5px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #FF6B35;
            color: white;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:disabled {
            background: #ccc;
        }

        .qty-display {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
            color: #333;
        }

        .discount-banner {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            padding: 15px 20px;
            margin: 15px;
            border-radius: 12px;
        }

        .discount-banner h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        /* –°–¢–ê–¢–£–° –ë–ê–† –í–ù–ò–ó–£ */
        .bottom-status-bar {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 999;
        }

        .status-bar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .status-bar-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .status-bar-amount {
            font-size: 14px;
            color: #666;
        }

        .progress-bar {
            height: 8px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            transition: all 0.3s;
        }

        .progress-fill.red { background: #FF6B35; }
        .progress-fill.yellow { background: #FFC107; }
        .progress-fill.green { background: #4CAF50; }

        .status-message {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #loader.hidden { display: none; }

        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-text {
            color: white;
            margin-top: 20px;
        }

        /* –í–°–ü–õ–´–í–ê–Æ–©–ò–ô –ú–û–¢–ò–í–ê–¢–û–† */
        .motivator-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10001;
            max-width: 90%;
            width: 350px;
            animation: popupAppear 0.3s forwards;
        }

        .motivator-popup.active {
            display: block;
        }

        @keyframes popupAppear {
            to {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .motivator-icon {
            font-size: 64px;
            text-align: center;
            margin-bottom: 15px;
        }

        .motivator-title {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            color: #333;
        }

        .motivator-message {
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
            color: #666;
            line-height: 1.4;
        }

        .motivator-buttons {
            display: flex;
            gap: 10px;
        }

        .motivator-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .motivator-btn.primary {
            background: #FF6B35;
            color: white;
        }

        .motivator-btn.secondary {
            background: #f5f5f5;
            color: #333;
        }

        .motivator-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
        }

        .motivator-overlay.active {
            display: block;
        }

        /* –ö–û–†–ó–ò–ù–ê */
        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            overflow-y: auto;
        }

        .cart-modal.active { display: block; }

        .cart-content {
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 12px;
        }

        .cart-header h2 {
            font-size: 24px;
            color: #333;
        }

        .close-cart {
            font-size: 32px;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
        }

        .cart-items-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .cart-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .cart-item:last-child { border-bottom: none; }

        .cart-item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .cart-item-info { flex: 1; }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .cart-item-price {
            color: #FF6B35;
            font-weight: bold;
            font-size: 14px;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .cart-item-total {
            margin-left: auto;
            font-weight: bold;
            color: #333;
        }

        .upsell-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .upsell-section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }

        .upsell-items {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .upsell-items::-webkit-scrollbar { display: none; }

        .upsell-item {
            min-width: 150px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .upsell-item-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .upsell-item-price {
            color: #FF6B35;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .add-upsell-btn {
            width: 100%;
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px;
            font-weight: 600;
        }

        .cart-summary {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 15px;
            color: #333;
        }

        .summary-row.discount { color: #4CAF50; }

        .summary-row.total {
            font-size: 20px;
            font-weight: bold;
            color: #FF6B35;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
            margin-top: 10px;
        }

        .bonus-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .bonus-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .bonus-checkbox input { width: 20px; height: 20px; }

        .bonus-checkbox label {
            flex: 1;
            color: #333;
        }

        .bonus-amount {
            font-weight: bold;
            color: #9C27B0;
        }

        .bonus-info {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .payment-method {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .payment-method h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }

        .payment-options {
            display: flex;
            gap: 10px;
        }

        .payment-option {
            flex: 1;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            color: #333;
            font-weight: 600;
        }

        .payment-option.active {
            border-color: #FF6B35;
            background: #FFF5F2;
            color: #FF6B35;
        }

        .delivery-date {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .delivery-date h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }

        .date-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            color: #333;
        }

        .comment-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .comment-section h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }

        .comment-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            color: #333;
        }

        .confirm-order-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #FF6B35 0%, #FF8C61 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
        }

        #regModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
        }

        .modal-content h2 {
            margin-bottom: 16px;
            color: #FF6B35;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .modal-content button {
            width: 100%;
            padding: 14px;
            background: #FF6B35;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="header">
        <h1>üçø HappySnack</h1>
        <div class="search-box">
            <span>üîç</span>
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤...">
        </div>
    </div>

    <div class="discount-banner" id="discountBanner" style="display: none;">
        <h3>üéâ –ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ —Å–æ —Å–∫–∏–¥–∫–æ–π!</h3>
        <p>–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–∫–∞–∑–µ –æ—Ç 10,000‚Ç∏ —Å–∫–∏–¥–∫–∞ 5%</p>
    </div>

    <div class="categories" id="categories"></div>
    <div class="products" id="products"></div>

    <div class="bottom-status-bar" id="bottomStatusBar" style="display: none;">
        <div class="status-bar-header">
            <span class="status-bar-title" id="statusTitle">–î–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏</span>
            <span class="status-bar-amount" id="statusAmount">0‚Ç∏</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill red" id="statusProgress" style="width: 0%"></div>
        </div>
        <div class="status-message" id="statusMessage">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ 15,000‚Ç∏</div>
    </div>

    <!-- –í–°–ü–õ–´–í–ê–Æ–©–ò–ô –ú–û–¢–ò–í–ê–¢–û–† -->
    <div class="motivator-overlay" id="motivatorOverlay" onclick="closeMotivator()"></div>
    <div class="motivator-popup" id="motivatorPopup">
        <div class="motivator-icon" id="motivatorIcon">üéÅ</div>
        <div class="motivator-title" id="motivatorTitle">–ü–æ—á—Ç–∏ —É —Ü–µ–ª–∏!</div>
        <div class="motivator-message" id="motivatorMessage">–î–æ–±–∞–≤—å—Ç–µ –µ—â—ë —Ç–æ–≤–∞—Ä–æ–≤ –∏ –ø–æ–ª—É—á–∏—Ç–µ –±–æ–Ω—É—Å!</div>
        <div class="motivator-buttons">
            <button class="motivator-btn primary" onclick="closeMotivator()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</button>
            <button class="motivator-btn secondary" onclick="closeMotivatorAndOpenCart()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ö–û–†–ó–ò–ù–´ -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h2>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
                <button class="close-cart" onclick="closeCart()">√ó</button>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å-–±–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
            <div class="bottom-status-bar" id="cartStatusBar" style="display: none; position: relative; bottom: auto; margin: 15px 0;">
                <div class="status-bar-header">
                    <span class="status-bar-title" id="cartStatusTitle">–î–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏</span>
                    <span class="status-bar-amount" id="cartStatusAmount">0‚Ç∏</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill red" id="cartStatusProgress" style="width: 0%"></div>
                </div>
                <div class="status-message" id="cartStatusMessage">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ 15,000‚Ç∏</div>
            </div>

            <div class="cart-items-section">
                <div id="cartItems"></div>
            </div>

            <div class="upsell-section" id="upsellSection" style="display: none;">
                <h3>üî• –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å</h3>
                <div class="upsell-items" id="upsellItems"></div>
            </div>

            <div class="cart-summary">
                <div class="summary-row">
                    <span>–¢–æ–≤–∞—Ä—ã:</span>
                    <span id="cartSubtotal">0‚Ç∏</span>
                </div>
                <div class="summary-row discount" id="bonusDiscountRow" style="display: none;">
                    <span>üíé –û–ø–ª–∞—á–µ–Ω–æ –±–æ–Ω—É—Å–∞–º–∏:</span>
                    <span id="bonusDiscount">0‚Ç∏</span>
                </div>
                <div class="summary-row" id="bonusEarnRow" style="display: none;">
                    <span>üéÅ –ë–æ–Ω—É—Å–æ–≤ –∫ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é:</span>
                    <span id="cartBonus" style="color: #9C27B0; font-weight: bold;">0‚Ç∏</span>
                </div>
                <div class="summary-row total">
                    <span>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
                    <span id="cartTotal">0‚Ç∏</span>
                </div>
            </div>

            <div class="bonus-section" id="bonusSection" style="display: none;">
                <div class="bonus-checkbox" onclick="toggleBonusUsage()">
                    <input type="checkbox" id="useBonusCheckbox">
                    <label for="useBonusCheckbox">
                        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–Ω—É—Å—ã<br>
                        <small style="color: #666;">–î–æ—Å—Ç—É–ø–Ω–æ: <span class="bonus-amount" id="availableBonuses">0‚Ç∏</span></small>
                    </label>
                </div>
                <div class="bonus-info" id="bonusInfo" style="display: none;">
                    üí° –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ 70% –æ—Ç —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞
                </div>
            </div>

            <div class="payment-method">
                <h3>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
                <div class="payment-options">
                    <div class="payment-option active" data-method="cash" onclick="selectPayment('cash')">üíµ –ù–∞–ª–∏—á–Ω—ã–µ</div>
                    <div class="payment-option" data-method="card" onclick="selectPayment('card')">üí≥ –ë–µ–∑–Ω–∞–ª</div>
                </div>
            </div>

            <div class="delivery-date">
                <h3>–ñ–µ–ª–∞–µ–º–∞—è –¥–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                <input type="date" class="date-input" id="deliveryDate">
            </div>

            <div class="comment-section">
                <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</h3>
                <textarea class="comment-input" id="orderComment" placeholder="–£–∫–∞–∂–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏, –∞–¥—Ä–µ—Å –∏–ª–∏ –¥—Ä—É–≥–∏–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è..."></textarea>
            </div>

            <button class="confirm-order-btn" onclick="confirmOrder()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>

    <div id="regModal">
        <div class="modal-content">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <p style="margin-bottom: 16px; color: #666;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞:</p>
            <input type="text" id="regCompanyName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ / –ò–ü">
            <input type="text" id="regAddress" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏">
            <input type="tel" id="regPhone" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω">
            <button onclick="submitRegistration()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>

<script>
    let tg = null;
    let products = [];
    let categories = [];
    let cart = {};
    let currentCategory = 'all';
    let is_first_order = false;
    let needsRegistration = false;
    let selectedPaymentMethod = 'cash';
    let clientBonusBalance = 0;
    let useBonuses = false;
    let hasUnsavedOrder = false;
    let lastShownMotivator = 0; // Timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–∫–∞–∑–∞

    let BONUS_EARN_PERCENT = 3;
    let BONUS_MAX_USE_PERCENT = 70;

    let STATUS_TIERS = [
        { threshold: 15000, title: '–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞', emoji: 'üöö', message: '–î–æ–±–∞–≤—å—Ç–µ –µ—â—ë –Ω–∞ {amount}‚Ç∏ –∏ –ø–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É!' },
        { threshold: 25000, title: '–£–ø–∞–∫–æ–≤–∫–∞ –∫–≤–∞—Å–∞ –≤ –ø–æ–¥–∞—Ä–æ–∫', emoji: 'ü•§', message: '–ï—â—ë {amount}‚Ç∏ –∏ —É–ø–∞–∫–æ–≤–∫–∞ –∫–≤–∞—Å–∞ –≤–∞—à–∞!' },
        { threshold: 50000, title: '5% —Å–∫–∏–¥–∫–∞ –Ω–∞ –∑–∞–∫–∞–∑', emoji: 'üí∞', message: '–î–æ —Å–∫–∏–¥–∫–∏ 5% –æ—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ {amount}‚Ç∏!' }
    ];

    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ API (–ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç UI)
    function loadSettings() {
        fetch('/api/settings')
            .then(response => response.json())
            .then(settings => {
                BONUS_EARN_PERCENT = settings.bonus_earn_percent || 3;
                BONUS_MAX_USE_PERCENT = settings.bonus_max_use_percent || 70;
                
                if (settings.tier1_threshold) STATUS_TIERS[0].threshold = settings.tier1_threshold;
                if (settings.tier2_threshold) STATUS_TIERS[1].threshold = settings.tier2_threshold;
                if (settings.tier3_threshold) STATUS_TIERS[2].threshold = settings.tier3_threshold;
                
                console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', settings);
            })
            .catch(error => {
                console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º defaults:', error);
            });
    }

    function getTg() {
        return window.Telegram?.WebApp || null;
    }

    function hideLoader() {
        const loader = document.getElementById('loader');
        if (loader) loader.classList.add('hidden');
    }

    function formatPrice(price) {
        return parseInt(price).toLocaleString();
    }

    // –í–°–ü–õ–´–í–ê–Æ–©–ò–ï –ú–û–¢–ò–í–ê–¢–û–†–´
    function showMotivator(icon, title, message) {
        const now = Date.now();
        // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 10 —Å–µ–∫—É–Ω–¥
        if (now - lastShownMotivator < 3000) return;
        
        lastShownMotivator = now;
        
        document.getElementById('motivatorIcon').textContent = icon;
        document.getElementById('motivatorTitle').textContent = title;
        document.getElementById('motivatorMessage').textContent = message;
        document.getElementById('motivatorOverlay').classList.add('active');
        document.getElementById('motivatorPopup').classList.add('active');
        
        // –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(closeMotivator, 5000);
    }

    window.closeMotivator = function() {
        document.getElementById('motivatorOverlay').classList.remove('active');
        document.getElementById('motivatorPopup').classList.remove('active');
    };

    window.closeMotivatorAndOpenCart = function() {
        closeMotivator();
        showCart();
    };

    function checkAndShowMotivator() {
        const total = calculateSubtotal();
        if (total === 0) return;

        const nextTier = STATUS_TIERS.find(tier => total < tier.threshold);
        if (!nextTier) return;

        const remaining = nextTier.threshold - total;
        const progress = (total / nextTier.threshold) * 100;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –±–ª–∏–∑–∫–æ –∫ –ø–æ—Ä–æ–≥—É (80-95%)
        if (progress >= 60 && progress < 100) {
            const message = nextTier.message.replace('{amount}', formatPrice(remaining));
            showMotivator(nextTier.emoji, nextTier.title, message);
        }
    }

    function renderCategories() {
        const container = document.getElementById('categories');
        if (!container) return;

        const allButton = `<div class="category-chip active" data-category="all" onclick="filterByCategory('all')">–í—Å–µ</div>`;
        const categoryButtons = categories.map(cat => 
            `<div class="category-chip" data-category="${cat.id}" onclick="filterByCategory(${cat.id})">${cat.icon} ${cat.name}</div>`
        ).join('');

        container.innerHTML = allButton + categoryButtons;

        if (is_first_order) {
            document.getElementById('discountBanner').style.display = 'block';
        }
    }

    function renderProducts() {
        const productsContainer = document.getElementById('products');
        if (!productsContainer) return;

        if (!products.length) {
            productsContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }

        productsContainer.innerHTML = products.map(product => {
            if (currentCategory !== 'all' && product.category_id != currentCategory) return '';

            const count = cart[product.id] || 0;

            return `
                <div class="product-card">
                    ${product.photo_url 
                        ? `<img src="${product.photo_url}" alt="${product.name}" class="product-image">`
                        : '<div class="product-image placeholder">üì∑</div>'
                    }
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${formatPrice(product.price)} ‚Ç∏</div>
                        <div class="product-actions">
                            ${count === 0 
                                ? `<button class="qty-btn" style="width:100%;" onclick="changeQty(${product.id}, 1)">–î–æ–±–∞–≤–∏—Ç—å</button>`
                                : `<div class="qty-control">
                                       <button class="qty-btn" onclick="changeQty(${product.id}, -1)">‚àí</button>
                                       <span class="qty-display">${count}</span>
                                       <button class="qty-btn" onclick="changeQty(${product.id}, 1)">+</button>
                                   </div>`
                            }
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        updateCartDisplay();
    }

    function filterByCategory(categoryId) {
        currentCategory = categoryId;
        document.querySelectorAll('.category-chip').forEach(chip => {
            chip.classList.toggle('active', chip.dataset.category == categoryId);
        });
        renderProducts();
    }

    window.changeQty = function(productId, delta) {
        const product = products.find(p => p.id === productId);
        if (!product) return;

        const current = cart[productId] || 0;
        const newQty = Math.max(0, current + delta);

        if (newQty === 0) {
            delete cart[productId];
        } else {
            cart[productId] = newQty;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ—Ç–∏–≤–∞—Ç–æ—Ä –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞
            if (delta > 0) {
            }
        }

        hasUnsavedOrder = Object.keys(cart).length > 0;
        renderProducts();
        updateCartDisplay();
        updateStatusBar();
        
        if (document.getElementById('cartModal').classList.contains('active')) {
            renderCartItems();
            updateCartSummary();
        }
    };

    function updateCartDisplay() {
        const itemCount = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
        const subtotal = calculateSubtotal();

        if (!tg || !tg.MainButton) return;

        if (itemCount === 0) {
            tg.MainButton.hide();
            document.getElementById('bottomStatusBar').style.display = 'none';
            hasUnsavedOrder = false;
            return;
        }

        // –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º subtotal, updateCartSummary –æ–±–Ω–æ–≤–∏—Ç —Å —É—á—ë—Ç–æ–º –±–æ–Ω—É—Å–æ–≤
        tg.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑: ${formatPrice(subtotal)}‚Ç∏`);
        tg.MainButton.show();
        tg.MainButton.enable();
        
        updateStatusBar();
    }

    function calculateSubtotal() {
        return Object.entries(cart).reduce((sum, [id, qty]) => {
            const product = products.find(p => String(p.id) === String(id));
            return sum + (product ? product.price * qty : 0);
        }, 0);
    }

    function updateStatusBar() {
        const total = calculateSubtotal();
        const bar = document.getElementById('bottomStatusBar');
        
        if (total === 0) {
            bar.style.display = 'none';
            return;
        }

        bar.style.display = 'block';
        
        const currentTier = STATUS_TIERS.find(tier => total < tier.threshold);
        
        if (currentTier) {
            const progress = Math.min((total / currentTier.threshold) * 100, 100);
            const remaining = currentTier.threshold - total;
            
            document.getElementById('statusTitle').textContent = `${currentTier.emoji} ${currentTier.title}`;
            document.getElementById('statusAmount').textContent = `${formatPrice(Math.max(0, remaining))}‚Ç∏`;
            document.getElementById('statusProgress').style.width = `${progress}%`;
            document.getElementById('statusMessage').textContent = 
                remaining > 0 ? `–î–æ–±–∞–≤—å—Ç–µ –µ—â—ë –Ω–∞ ${formatPrice(remaining)}‚Ç∏` : 'üéâ –ü–æ—Ä–æ–≥ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!';
            
            const progressEl = document.getElementById('statusProgress');
            progressEl.className = 'progress-fill';
            if (progress < 50) progressEl.classList.add('red');
            else if (progress < 90) progressEl.classList.add('yellow');
            else progressEl.classList.add('green');
        }
    }

    function updateCartStatusBar() {
        const total = calculateSubtotal();
        const bar = document.getElementById('cartStatusBar');
        
        if (total === 0) {
            bar.style.display = 'none';
            return;
        }

        bar.style.display = 'block';
        
        const currentTier = STATUS_TIERS.find(tier => total < tier.threshold);
        
        if (currentTier) {
            const progress = Math.min((total / currentTier.threshold) * 100, 100);
            const remaining = currentTier.threshold - total;
            
            document.getElementById('cartStatusTitle').textContent = `${currentTier.emoji} ${currentTier.title}`;
            document.getElementById('cartStatusAmount').textContent = `${formatPrice(Math.max(0, remaining))}‚Ç∏`;
            document.getElementById('cartStatusProgress').style.width = `${progress}%`;
            document.getElementById('cartStatusMessage').textContent = 
                remaining > 0 ? `–î–æ–±–∞–≤—å—Ç–µ –µ—â—ë –Ω–∞ ${formatPrice(remaining)}‚Ç∏` : 'üéâ –ü–æ—Ä–æ–≥ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç!';
            
            const progressEl = document.getElementById('cartStatusProgress');
            progressEl.className = 'progress-fill';
            if (progress < 50) progressEl.classList.add('red');
            else if (progress < 90) progressEl.classList.add('yellow');
            else progressEl.classList.add('green');
        } else {
            document.getElementById('cartStatusTitle').textContent = 'üéâ –í—Å–µ –ø–æ—Ä–æ–≥–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã!';
            document.getElementById('cartStatusAmount').textContent = '';
            document.getElementById('cartStatusProgress').style.width = '100%';
            document.getElementById('cartStatusProgress').className = 'progress-fill green';
            document.getElementById('cartStatusMessage').textContent = '–û—Ç–ª–∏—á–Ω—ã–π –∑–∞–∫–∞–∑!';
        }
    }

    function showCart() {
        renderCartItems();
        updateCartSummary();
        showUpsells();
        updateCartStatusBar();
        setupDatePicker();
        document.getElementById('cartModal').classList.add('active');
        
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É
        if (tg && tg.MainButton) {
            tg.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑: ${formatPrice(finalTotal)}‚Ç∏`);
        }
    }

    function renderCartItems() {
        const container = document.getElementById('cartItems');
        
        let cartHTML = '';
        Object.entries(cart).forEach(([productId, qty]) => {
            const product = products.find(p => p.id == productId);
            if (!product) return;
            
            const itemTotal = product.price * qty;
            
            cartHTML += `
                <div class="cart-item">
                    <div class="cart-item-image">üì∑</div>
                    <div class="cart-item-info">
                        <div class="cart-item-name">${product.name}</div>
                        <div class="cart-item-price">${formatPrice(product.price)}‚Ç∏ √ó ${qty}</div>
                        <div class="cart-item-controls">
                            <div class="qty-control">
                                <button class="qty-btn" onclick="changeQty(${product.id}, -1)">‚àí</button>
                                <span class="qty-display">${qty}</span>
                                <button class="qty-btn" onclick="changeQty(${product.id}, 1)">+</button>
                            </div>
                            <span class="cart-item-total">${formatPrice(itemTotal)}‚Ç∏</span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = cartHTML;
    }

    function updateCartSummary() {
        const subtotal = calculateSubtotal();
        let bonusUsed = 0;
        let finalTotal = subtotal;
        
        if (useBonuses && clientBonusBalance > 0) {
            const maxBonusUse = Math.floor(subtotal * BONUS_MAX_USE_PERCENT / 100);
            bonusUsed = Math.min(clientBonusBalance, maxBonusUse);
            finalTotal = subtotal - bonusUsed;
        }
        
        const bonusEarn = Math.floor(finalTotal * BONUS_EARN_PERCENT / 100);
        
        document.getElementById('cartSubtotal').textContent = `${formatPrice(subtotal)}‚Ç∏`;
        
        const bonusDiscountRow = document.getElementById('bonusDiscountRow');
        if (bonusUsed > 0) {
            bonusDiscountRow.style.display = 'flex';
            document.getElementById('bonusDiscount').textContent = `-${formatPrice(bonusUsed)}‚Ç∏`;
        } else {
            bonusDiscountRow.style.display = 'none';
        }
        
        const bonusEarnRow = document.getElementById('bonusEarnRow');
        if (bonusEarn > 0) {
            bonusEarnRow.style.display = 'flex';
            document.getElementById('cartBonus').textContent = `+${formatPrice(bonusEarn)}‚Ç∏`;
        } else {
            bonusEarnRow.style.display = 'none';
        }
        
        document.getElementById('cartTotal').textContent = `${formatPrice(finalTotal)}‚Ç∏`;
        
        updateBonusSection(subtotal);
        updateCartStatusBar();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–Ω–∏–∑—É
        if (tg && tg.MainButton) {
            tg.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑: ${formatPrice(finalTotal)}‚Ç∏`);
        }
    }

    function updateBonusSection(subtotal) {
        const bonusSection = document.getElementById('bonusSection');
        
        if (clientBonusBalance > 0) {
            bonusSection.style.display = 'block';
            
            const maxBonusUse = Math.floor(subtotal * BONUS_MAX_USE_PERCENT / 100);
            const availableToUse = Math.min(clientBonusBalance, maxBonusUse);
            
            document.getElementById('availableBonuses').textContent = `${formatPrice(availableToUse)}‚Ç∏`;
            
            const bonusInfo = document.getElementById('bonusInfo');
            bonusInfo.style.display = useBonuses ? 'block' : 'none';
        } else {
            bonusSection.style.display = 'none';
        }
    }

    window.toggleBonusUsage = function() {
        const checkbox = document.getElementById('useBonusCheckbox');
        useBonuses = checkbox.checked;
        updateCartSummary();
    };

    function showUpsells() {
        const upsellSection = document.getElementById('upsellSection');
        const upsellContainer = document.getElementById('upsellItems');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï —Ç–æ–≤–∞—Ä—ã (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ)
        const randomProducts = products
            .sort(() => Math.random() - 0.5)
            .slice(0, 5); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 5 —Å–ª—É—á–∞–π–Ω—ã—Ö
        
        if (randomProducts.length > 0) {
            upsellSection.style.display = 'block';
            upsellContainer.innerHTML = randomProducts.map(product => {
                const inCart = cart[product.id] || 0;
                const buttonText = '+ –î–æ–±–∞–≤–∏—Ç—å';
                
                return `
                    <div class="upsell-item">
                        <div class="upsell-item-name">${product.name}</div>
                        <div class="upsell-item-price">${formatPrice(product.price)}‚Ç∏</div>
                        <button class="add-upsell-btn" onclick="addUpsell(${product.id})">${buttonText}</button>
                    </div>
                `;
            }).join('');
        } else {
            upsellSection.style.display = 'none';
        }
    }

    window.addUpsell = function(productId) {
        const current = cart[productId] || 0;
        cart[productId] = current + 1;
        hasUnsavedOrder = true;
        renderCartItems();
        updateCartSummary();
        renderProducts();
        updateStatusBar();
        showUpsells();
    };

    window.closeCart = function() {
        if (hasUnsavedOrder && Object.keys(cart).length > 0) {
            
            if (tg && tg.showConfirm) {
                tg.showConfirm('–ó–∞–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É –±–µ–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞?', (confirmed) => {
                    if (confirmed) document.getElementById('cartModal').classList.remove('active');
                });
            } else {
                if (confirm('–ó–∞–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É –±–µ–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞?')) {
                    document.getElementById('cartModal').classList.remove('active');
                }
            }
        } else {
            document.getElementById('cartModal').classList.remove('active');
        }
    };

    window.selectPayment = function(method) {
        selectedPaymentMethod = method;
        document.querySelectorAll('.payment-option').forEach(opt => {
            opt.classList.toggle('active', opt.dataset.method === method);
        });
    };

    function setupDatePicker() {
        const dateInput = document.getElementById('deliveryDate');
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        dateInput.min = tomorrow.toISOString().split('T')[0];
        
        const maxDate = new Date(today);
        maxDate.setDate(maxDate.getDate() + 30);
        dateInput.max = maxDate.toISOString().split('T')[0];
        
        dateInput.addEventListener('input', function() {
            const selectedDate = new Date(this.value);
            const dayOfWeek = selectedDate.getDay();
            
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                alert('–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º –Ω–µ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –±—É–¥–Ω–∏–π –¥–µ–Ω—å.');
                this.value = '';
            }
        });
    }

    window.confirmOrder = async function() {
        if (!tg) return;

        const subtotal = calculateSubtotal();
        let bonusUsed = 0;
        
        if (useBonuses && clientBonusBalance > 0) {
            const maxBonusUse = Math.floor(subtotal * BONUS_MAX_USE_PERCENT / 100);
            bonusUsed = Math.min(clientBonusBalance, maxBonusUse);
        }
        
        const finalTotal = subtotal - bonusUsed;
        const bonusEarn = Math.floor(finalTotal * BONUS_EARN_PERCENT / 100);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞
        const MIN_ORDER_AMOUNT = 10000;
        if (finalTotal < MIN_ORDER_AMOUNT) {
            tg.showAlert(`‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ ${formatPrice(MIN_ORDER_AMOUNT)}‚Ç∏\n\n–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞: ${formatPrice(finalTotal)}‚Ç∏\n–î–æ–±–∞–≤—å—Ç–µ –µ—â—ë —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ ${formatPrice(MIN_ORDER_AMOUNT - finalTotal)}‚Ç∏`);
            return;
        }

        document.getElementById('cartModal').classList.remove('active');
        tg.MainButton.showProgress();

        try {
            const orderData = {
                user_id: tg.initDataUnsafe.user?.id,
                cart: cart,
                payment_method: selectedPaymentMethod,
                notes: document.getElementById('orderComment').value || '',
                delivery_date: document.getElementById('deliveryDate').value || null,
                bonus_used: bonusUsed
            };

            const response = await fetch('/api/orders/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                let message = `‚úÖ –ó–∞–∫–∞–∑ #${result.order_id} –ø—Ä–∏–Ω—è—Ç!\n\nüí∞ –°—É–º–º–∞: ${formatPrice(subtotal)}‚Ç∏\n`;
                
                if (bonusUsed > 0) message += `üíé –û–ø–ª–∞—á–µ–Ω–æ –±–æ–Ω—É—Å–∞–º–∏: ${formatPrice(bonusUsed)}‚Ç∏\n`;
                message += `üíµ –ö –æ–ø–ª–∞—Ç–µ: ${formatPrice(finalTotal)}‚Ç∏\n`;
                if (bonusEarn > 0) message += `üéÅ –ë–æ–Ω—É—Å–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +${formatPrice(bonusEarn)}‚Ç∏\n`;
                message += `\nüôè –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.`;

                tg.showAlert(message);

                cart = {};
                useBonuses = false;
                hasUnsavedOrder = false;
                updateCartDisplay();
                renderProducts();
                updateStatusBar();

                setTimeout(() => tg.close(), 3000);
            } else {
                throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');
            }

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–∫–∞–∑–∞:', error);
            tg.showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        } finally {
            tg.MainButton.hideProgress();
        }
    };

    async function loadData() {
        try {
            let userId = '';
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                userId = tg.initDataUnsafe.user.id;
            }

            const response = await fetch(`/api/catalog?user_id=${userId}`, { cache: 'no-store' });
            const data = await response.json();

            products = data.products || [];
            categories = data.categories || [];
            is_first_order = !!data.is_first_order;
            needsRegistration = !!data.needs_registration;
            clientBonusBalance = data.bonus_balance || 0;

            renderCategories();
            renderProducts();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        } finally {
            hideLoader();
        }
    }

    window.submitRegistration = async function() {
        const company = document.getElementById('regCompanyName').value;
        const address = document.getElementById('regAddress').value;
        const phone = document.getElementById('regPhone').value;

        if (!company || !address || !phone) {
            tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
            return;
        }

        tg.MainButton.showProgress();

        try {
            const regResponse = await fetch('/api/client/profile/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: tg.initDataUnsafe.user?.id,
                    company_name: company,
                    address: address,
                    contact_phone: phone
                })
            });

            if (regResponse.ok) {
                needsRegistration = false;
                document.getElementById('regModal').style.display = 'none';
                showCart();
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        } catch (e) {
            tg.showAlert('–û—à–∏–±–∫–∞: ' + e.message);
            tg.MainButton.hideProgress();
        }
    };

    function startApp() {
        loadSettings(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
        tg = getTg();

        if (tg) {
            tg.ready();
            tg.expand();
            tg.enableClosingConfirmation();

            tg.MainButton.onClick(async () => {
                if (!settingsLoaded) {
                    console.log("‚è≥ –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫...");
                    return;
                }
                if (needsRegistration) {
                    document.getElementById('regModal').style.display = 'flex';
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–∏–∑–æ—Å—Ç—å –∫ –ø–æ—Ä–æ–≥—É
                const total = calculateSubtotal();
                const nextTier = STATUS_TIERS.find(tier => total < tier.threshold);
                
                if (nextTier) {
                    const remaining = nextTier.threshold - total;
                    const progress = (total / nextTier.threshold) * 100;
                    
                    // –ï—Å–ª–∏ –±–ª–∏–∑–∫–æ –∫ –ø–æ—Ä–æ–≥—É (70-95%), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ—Ç–∏–≤–∞—Ç–æ—Ä
                    if (progress >= 70 && progress < 100) {
                        const message = nextTier.message.replace('{amount}', formatPrice(remaining));
                        showMotivator(nextTier.emoji, nextTier.title, message);
                        return; // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
                    }
                }
                
                showCart();
            });

            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedOrder) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        }

        setTimeout(() => hideLoader(), 8000);
        loadData();
    }

    document.addEventListener('DOMContentLoaded', startApp);
</script>

</body>
</html>