<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FF6B35">
    <title>HappySnack - –ö–∞—Ç–∞–ª–æ–≥</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #FF6B35 0%, #FF8C61 100%);
            padding: 20px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .search-box {
            background: white;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .search-box input {
            border: none;
            outline: none;
            flex: 1;
            font-size: 16px;
            color: #333;
        }

        .categories {
            display: flex;
            overflow-x: auto;
            padding: 15px;
            gap: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .categories::-webkit-scrollbar {
            display: none;
        }

        .category-chip {
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 10px 20px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-chip.active {
            background: #FF6B35;
            color: white;
            border-color: #FF6B35;
        }

        .products {
            padding: 15px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: #f5f5f5;
            flex-shrink: 0;
        }

        .product-image.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .product-price {
            font-size: 18px;
            font-weight: bold;
            color: #FF6B35;
            margin-bottom: 5px;
        }

        .product-stock {
            font-size: 13px;
            color: #666;
        }

        .product-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 5px;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #FF6B35;
            color: white;
            border-radius: 6px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qty-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .qty-display {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
        }

        .cart-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FF6B35 0%, #FF8C61 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 18px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
        }

        .cart-button:disabled {
            background: #ccc;
            box-shadow: none;
        }

        .discount-banner {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
            color: white;
            padding: 15px 20px;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .discount-banner h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .discount-banner p {
            font-size: 14px;
            opacity: 0.95;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .install-prompt {
            background: linear-gradient(135deg, #2196F3 0%, #42A5F5 100%);
            color: white;
            padding: 15px 20px;
            margin: 15px;
            border-radius: 12px;
            display: none;
        }

        .install-prompt button {
            background: white;
            color: #2196F3;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }
    
    #loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        transition: opacity 0.3s ease;
    }
    
    #loader.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .loader-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255,255,255,0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    .loader-text {
        color: white;
        margin-top: 20px;
        font-size: 16px;
        font-weight: 500;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    body.loading #app {
        opacity: 0;
    }
    
    body.loaded #app {
        opacity: 1;
        transition: opacity 0.3s ease;
    }

    </style>
</head>
<body class="loading">
    <div id="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">üçø –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥...</div>
    </div>

    <div id="installPrompt" class="install-prompt">
        <h3>üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
        <p>–î–æ–±–∞–≤—å—Ç–µ HappySnack –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞!</p>
        <button onclick="installApp()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div class="header">
        <h1>üçø HappySnack</h1>
        <div class="search-box">
            <span style="margin-right: 10px;">üîç</span>
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤...">
        </div>
    </div>

    <div id="discountBanner" class="discount-banner" style="display: none;">
        <h3>üéâ –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!</h3>
        <p id="discountText"></p>
    </div>

    <div class="categories" id="categories">
        <div class="category-chip active" data-category="all">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</div>
    </div>

    <div class="products" id="products">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
    </div>

    <button class="cart-button" id="cartButton" disabled>
        <span id="cartInfo">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</span>
        <span id="cartTotal">0‚Ç∏</span>
    </button>

   <script>
    const API_BASE = '/api';
  
  function hideLoader() {
    const loader = document.getElementById("loader");
    document.body.classList.remove("loading");
    document.body.classList.add("loaded");
    if (loader) {
      loader.classList.add("hidden");
      setTimeout(() => loader.remove(), 300);
    }
  }

  function getTg() {
    try {
      return window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    } catch (e) {
      return null;
    }
  }

  let tg = null;
  let products = [];
  let categories = [];
  let cart = {};
  let currentCategory = "all";
  let isFirstOrder = false;
  let deferredPrompt = null;

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const el = document.getElementById("installPrompt");
    if (el) el.style.display = "block";
  });

  window.installApp = function installApp() {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    deferredPrompt.userChoice.finally(() => {
      deferredPrompt = null;
      const el = document.getElementById("installPrompt");
      if (el) el.style.display = "none";
    });
  };

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker
      .register("/service-worker.js")
      .then((reg) => console.log("SW registered", reg))
      .catch((err) => console.log("SW failed", err));
  }

  function formatPrice(price) {
    return new Intl.NumberFormat("ru-RU").format(Math.round(price || 0));
  }

  function getProductWord(count) {
    const lastDigit = count % 10;
    const lastTwoDigits = count % 100;
    if (lastTwoDigits >= 11 && lastTwoDigits <= 19) return "—Ç–æ–≤–∞—Ä–æ–≤";
    if (lastDigit === 1) return "—Ç–æ–≤–∞—Ä";
    if (lastDigit >= 2 && lastDigit <= 4) return "—Ç–æ–≤–∞—Ä–∞";
    return "—Ç–æ–≤–∞—Ä–æ–≤";
  }

  function calculateDiscount(total) {
    if (!isFirstOrder) return 0;
    if (total >= 50000) return total * 0.2;
    if (total >= 25000) return total * 0.15;
    if (total >= 15000) return total * 0.1;
    return 0;
  }

  function updateDiscountBanner() {
    const banner = document.getElementById("discountBanner");
    const text = document.getElementById("discountText");
    if (!banner || !text) return;

    if (isFirstOrder) {
      banner.style.display = "block";
      text.textContent = "–ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑: —Å–∫–∏–¥–∫–∞ 10-20% –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 15,000‚Ç∏!";
    } else {
      banner.style.display = "none";
    }
  }

  function renderCategories() {
    const container = document.getElementById("categories");
    if (!container) return;

    container.innerHTML = '<div class="category-chip active" data-category="all">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</div>';
    const allChip = container.querySelector('[data-category="all"]');
    if (allChip) allChip.onclick = () => filterByCategory("all");

    categories.forEach((cat) => {
      const chip = document.createElement("div");
      chip.className = "category-chip";
      chip.dataset.category = String(cat.id);
      chip.textContent = `${cat.icon || "üì¶"} ${cat.name}`;
      chip.onclick = () => filterByCategory(String(cat.id));
      container.appendChild(chip);
    });
  }

  function renderProducts() {
    const productsContainer = document.getElementById('products');

    if (!products || !products.length) {
        productsContainer.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üîç</div>
          <p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        </div>`;
        return;
    }

    const activeCategory = currentCategory;

    productsContainer.innerHTML = products.map(product => {
        if (activeCategory !== 'all' && product.category_id != activeCategory) {
            return '';
        }

        const count = cart[product.id] || 0;

        return `
      <div class="product-card">
        <div class="product-image-container">
          ${product.photo_url 
            ? '<img src="' + product.photo_url + '" alt="' + product.name + '" class="product-image" loading="lazy">'
            : '<div class="no-image">üì∑</div>'
          }
          ${count > 0 ? '<div class="product-badge">' + count + '</div>' : ''}
        </div>
        <div class="product-info">
          <div class="product-header">
            <h3 class="product-title">${product.name}</h3>
            <span class="product-price">${parseInt(product.price).toLocaleString()} ‚Ç∏</span>
          </div>
          
          ${count === 0 
            ? '<button class="add-btn" onclick="changeQty(' + product.id + ', 1)">–î–æ–±–∞–≤–∏—Ç—å</button>'
            : '<div class="counter-controls"><button class="counter-btn" onclick="changeQty(' + product.id + ', -1)">‚àí</button><span class="counter-value">' + count + '</span><button class="counter-btn" onclick="changeQty(' + product.id + ', 1)">+</button></div>'
          }
        </div>
      </div>`;
    }).join('');

    updateCartDisplay();
}

  function filterByCategory(categoryId) {
    currentCategory = categoryId;
    document.querySelectorAll(".category-chip").forEach((chip) => {
      chip.classList.toggle("active", chip.dataset.category == categoryId);
    });
    renderProducts();
  }

  window.changeQty = function changeQty(productId, delta) {
    const product = products.find((p) => p.id === productId);
    if (!product) return;

    const current = cart[productId] || 0;
    const newQty = Math.max(0, Math.min(product.stock, current + delta));

    if (newQty === 0) delete cart[productId];
    else cart[productId] = newQty;

    const qtyDisplay = document.getElementById(`qty-${productId}`);
    if (qtyDisplay) qtyDisplay.textContent = String(newQty);

    updateCartDisplay();
  };

  function updateCartDisplay() {
    const cartBtn = document.getElementById("cartButton");
    const cartInfo = document.getElementById("cartInfo");
    const cartTotal = document.getElementById("cartTotal");

    const itemCount = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
    const total = Object.entries(cart).reduce((sum, [id, qty]) => {
      const product = products.find((p) => String(p.id) === String(id));
      return sum + (product ? (product.price || 0) * qty : 0);
    }, 0);

    if (itemCount === 0) {
      if (cartBtn) cartBtn.disabled = true;
      if (cartInfo) cartInfo.textContent = "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞";
      if (cartTotal) cartTotal.textContent = "0‚Ç∏";
      if (tg && tg.MainButton) tg.MainButton.hide();
      return;
    }

    if (cartBtn) cartBtn.disabled = false;
    if (cartInfo) cartInfo.textContent = `${itemCount} ${getProductWord(itemCount)}`;

    let displayTotal = total;
    if (isFirstOrder) displayTotal = total - calculateDiscount(total);
    if (cartTotal) cartTotal.textContent = `${formatPrice(displayTotal)}‚Ç∏`;

    if (tg && tg.MainButton) {
      tg.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑: ${formatPrice(total)}‚Ç∏`);
      tg.MainButton.show();
      tg.MainButton.enable();
    }
  }

  const searchInput = document.getElementById("searchInput");
  if (searchInput) {
    searchInput.addEventListener("input", (e) => {
      console.log("–ü–æ–∏—Å–∫ –ø–æ:", (e.target.value || "").toLowerCase());
    });
  }

  async function loadData() {
    console.log("LOAD DATA START");

    try {
      let userId = "";
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
        userId = tg.initDataUnsafe.user.id;
      }

      const response = await fetch(`/api/catalog?user_id=${userId}`, { cache: "no-store" });
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

      const data = await response.json();

      products = data.products || [];
      categories = data.categories || [];
      isFirstOrder = !!data.is_first_order;

      renderCategories();
      renderProducts();
      updateDiscountBanner();
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
      const productsEl = document.getElementById("products");
      if (productsEl) {
        productsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</p></div>';
      }
    } finally {
      hideLoader();
    }
  }

  function startApp() {
    tg = getTg();
    if (tg) {
      tg.ready();
      tg.expand();
      
      tg.MainButton.onClick(async () => {
        const itemCount = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
        
        if (itemCount === 0) {
          tg.showAlert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
          return;
        }
        
        tg.MainButton.showProgress();
        
        try {
          const orderData = {
            user_id: tg.initDataUnsafe.user?.id,
            cart: cart,
            payment_method: 'cash',
            notes: ''
          };
          
          console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑:', orderData);
          
          const response = await fetch(`${API_BASE}/orders/create`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(orderData)
          });
          
          console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);
          const result = await response.json();
          console.log('–î–∞–Ω–Ω—ã–µ:', result);
          
          if (response.ok && result.success) {
            tg.showAlert(
              `‚úÖ –ó–∞–∫–∞–∑ #${result.order_id} –ø—Ä–∏–Ω—è—Ç!\n\n` +
              `üí∞ –°—É–º–º–∞: ${result.total.toLocaleString()}‚Ç∏\n` +
              `üéÅ –ë–æ–Ω—É—Å–æ–≤: +${result.bonus_earned.toLocaleString()}‚Ç∏`
            );
            
            cart = {};
            updateCartDisplay();
            renderProducts();
            
            setTimeout(() => tg.close(), 2000);
          } else {
            throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞');
          }
          
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–∫–∞–∑–∞:', error);
          tg.showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        } finally {
          tg.MainButton.hideProgress();
        }
      });
      
    } else {
      console.warn("Telegram WebApp not detected yet (ok for browser test).");
    }

    setTimeout(() => hideLoader(), 8000);
    loadData();
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadProducts(); // –£–±–µ–¥–∏—Å—å, —á—Ç–æ —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –Ω–∞ –º–µ—Å—Ç–µ!
});
</script>

</body>
</html>